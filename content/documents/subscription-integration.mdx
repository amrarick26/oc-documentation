---
type:           article
title:          Subscription Integration
description:    New resource required to process Subscription orders.
author:         asnyder
publishDate:    2023-03-06
updatedDate:    2023-03-06   
tags:           ["Concepts", "Marketplaces", "Orders"]
---

New OrderCloud resource required to process Subscription orders. Every hour, the OrderCloud platform will handle creating an Order, Line Items, 
and Payment for Subscriptions due for processing at that time based on the Subscription and Subscription Item data. This resource provides OrderCloud 
with the information needed to send relative data to a hosted application that will be responsible for payment validation, tax calculation and order submit.

## Key Highlights
- NotificationDays allows you to determine how many days before Subscription.NextOrderDate that a user is reminded via email their subscription order is coming up
- One per marketplace
- Cannot use an API Client that is currently associated with the Order Checkout Integration Event
- API Client used must have a DefaultContextUser defined

## New Resource: `Subscription Integration`

```json
{
	"ApiClientID": "", 
	"HashKey": "",
	"ElevatedRoles": [],
	"Active": true,
	"NotificationDays": 15,
	"Url": "",
	"xp": {},
}
```

**Endpoints:**
- `GET v1/integrations/subscription`
- `PUT v1/integrations/subscription`
- `PATCH v1/integrations/subscription`
- `DELETE v1/integrations/subscription`

Because there is only one per marketplace, there is no ID associated with the Subscription Integration

The hourly process queries for active Subscriptions, from an active user, with a NextOrderDate within the last five hours and an EndDate that is either null or in the future. 
If the process to create the Order, Line Items, and Payment fails, it will keep trying until NextOrderDate is more than five hours ago.

## Payload to hosted application
```json
{
    "Environment": "Sandbox",
    "OrderCloudAccessToken": "", // access token of the DefaultContextUser defined with your associated API Client
    "OrderWorksheet": {},
    "UnavailableProductIDs": ["inactiveProduct"],
    "ErrorCode": ""
}
```

### `/Success`
If OrderCloud was able to successfully create an Order, Line Items, and Payment per the defined Subscription and Subscription Items, the payload defined above 
will be sent to this endpoint in your hosted application. For example, if your `SubscriptionIntegration.Url` value is `myhostedapp.com/api/subscriptions`, OrderCloud 
will send the request to `myhostedapp.com/api/subscriptions/success`. Within this method, you will want to handle all your order submit logic such as payment validation, 
tax calculation, shipping designations, etc. You will also be responsible for submitting the order. If you currently utilize the Order Checkout Integration Event feature, 
you will call those methods directly from within your code handling this request.

### `/Failure`
If OrderCloud was unable to successfully create an Order, Line Items, or Payment per the defined Subscription and Subscription Items, the payload defined above 
will be sent to this hosted endpoint in your application. For example, if your `SubscriptionIntegration.Url` value is `myhostedapp.com/api/subscriptions`, OrderCloud 
will send the request to `myhostedapp.com/api/subscriptions/failure`. 

## Response to OrderCloud
```json
{ 
    "HttpStatusCode": 200,
    "UnhandledErrorBody": ""
}
```

Both of the endpoints defined above will need to have a response type matching the object above. If HttpStatusCode is of a successful value and UnhandledErrorBody is null, 
the Subscription.NextOrderDate will be updated based off of the defined Interval and Frequency on the Subscription. The response will be stored on the Order Worksheet as 
`SubscriptionIntegrationResponse`. 